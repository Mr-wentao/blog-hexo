---
title: 配置树莓派关机时正常停转移动硬盘
abbrlink: 8e3fdb74
categories:
  - 工具
tags:
  - 树莓派
  - Disk
date: 2022-05-02 14:54:40
---

将闲置的树莓派做个共享服务器，在家里面存一些文件用。将树莓派和移动硬盘盒都已经改装好了，固定在了一起，用一块12864来显示一些信息，比如磁盘空间占用等。

树莓派3B+的千兆网口和usb接口相当于是一个usb2.0 hub分出来的， 速度根本达不到千兆，还抢占usb的带宽。实测速度20M/s左右（硬盘速度能跑到100M/s）

![树莓派3B+](https://static.zahui.fan/images/raspberrypi-3b+.jpg)

## 遇到的问题

每次关机或者重启的时候，都会遇到硬盘吱~的一声，这种情况是操作系统关机的时候没有通知硬盘磁头归位直接断电， 这样硬盘会自己将磁头归位，就会有声音。时间久了对机械硬盘是一种损伤。

参考<http://www.linux-ata.org/shutdown.html>

## 解决方案

### 查找硬盘启停配置

在linux系统里面，一切皆文件，硬盘的各种信息也不列外。我们可以到`/sys/class/scsi_disk/`找自己的硬盘，可以通过查看硬盘的型号来确定

```bash
cat /sys/class/scsi_disk/0:0:0:0/device/model
```

文件`manage_start_stop`就是配置磁头归位的，只需要将此文件内容设置成1即可。需要每次开机后都执行。

```bash
sudo bash -c "echo 1 > /sys/class/scsi_disk/0\:0\:0\:0/manage_start_stop"
```

### 也可以批量对所有硬盘执行这个操作

```bash
for i in /sys/class/scsi_disk/*/manage_start_stop;do echo 1 > $i;done
```

### 设置开机自启动

个人喜欢使用systemd来进行开机自启动

`vim /etc/systemd/system/custom.service`

```ini
[Unit]
Description = Custom Startup Service

[Service]
Type = simple
ExecStart = /opt/scripts/custom.sh

[Install]
WantedBy = multi-user.target
```

将需要开机自定的命令写到`/opt/scripts/custom.sh`里面

`sudo systemctl enable custom.service`
